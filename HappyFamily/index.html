<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>简易 WebRTC 聊天</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #F7F8FC; /* 清淡银河灰 */
      color: #2B2346; /* 深星紫 */
    }

    /* 房间输入界面 */
    #roomEntry {
      display: flex;
      height: 100vh;
      align-items: center;
      justify-content: center;
      background-color: #F7F8FC;
    }

    #roomEntry input {
      padding: 10px 14px;
      border: 1px solid #C3B7F0; /* 柔和蓝紫边框 */
      border-radius: 10px;
      font-size: 16px;
      background-color: white;
      transition: border-color 0.2s;
    }

    #roomEntry input:focus {
      border-color: #8B6ECF; /* 主色调聚焦 */
      outline: none;
    }

    #roomEntry button {
      padding: 10px 16px;
      margin-left: 12px;
      background-color: #6A4FB6; /* 宇宙蓝紫 */
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(106, 79, 182, 0.4);
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    #roomEntry button:hover {
      background-color: #593aa5;
      box-shadow: 0 3px 8px rgba(89, 58, 165, 0.6);
    }

    /* 聊天容器 */
    #chatContainer {
      display: none;
      flex-direction: column;
      height: 100vh;
      background-color: #F7F8FC;

      /* flex容器 */
      display: flex;
    }

    /* 头部 */
    .chat-header {
      padding: 14px 16px;
      padding-left: 60px; /* 给左边多留出点空间给按钮 */
      background-color: #6A4FB6;
      color: white;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      position: relative;
      box-shadow: 0 2px 6px rgba(106, 79, 182, 0.4);
      user-select: none;

      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-shrink: 0; /* 不收缩 */
    }

    /* 语音按钮样式 */
    .call-btn {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #8B6ECF;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 20px;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(139, 110, 207, 0.6);
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      z-index: 10;
    }

    .call-btn:hover {
      background-color: #6A4FB6;
      box-shadow: 0 4px 12px rgba(106, 79, 182, 0.8);
      transform: translateY(-50%) scale(1.1);
    }

    .call-btn:active {
      transform: translateY(-50%) scale(0.95);
    }

    #statusIndicator {
      position: absolute;
      right: 16px;
      top: 14px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.75);
    }

    /* 聊天内容区 */
    .chat-messages {
      flex: 1 1 auto; /* 关键：撑满剩余空间 */
      padding: 32px 16px 16px 16px; /* 顶部多加点内边距 */
      overflow-y: auto;
      background-color: #ffffff;
      border-top: 1px solid #E5E3F4;
      border-bottom: 1px solid #E5E3F4;
      box-sizing: border-box; /* 确保padding计算在内 */
    }

    /* 聊天气泡 */
    .chat-messages div {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 70%;
      word-break: break-word;
      font-size: 15px;
      background-color: #ECE8FF; /* 淡紫色泡泡 */
      color: #2B2346;
      box-shadow: 0 1px 4px rgba(106, 79, 182, 0.15);
      transition: background-color 0.3s;
    }

    /* “我”的气泡样式 */
    /* 这里你用JS控制了背景色，CSS里不用写 :has() 了 */

    /* 输入区 */
    .chat-input {
      display: flex;
      padding: 14px 18px;
      background-color: #F7F8FC;
      border-top: 1px solid #E5E3F4;
      flex-shrink: 0; /* 不收缩 */
    }

    .chat-input input {
      flex: 1;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid #C3B7F0;
      border-radius: 10px;
      background-color: white;
      transition: border-color 0.3s;
    }

    .chat-input input:focus {
      border-color: #8B6ECF;
      outline: none;
    }

    .chat-input button {
      padding: 12px 18px;
      margin-left: 14px;
      font-size: 16px;
      background-color: #6A4FB6;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(106, 79, 182, 0.4);
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .chat-input button:hover {
      background-color: #593aa5;
      box-shadow: 0 3px 8px rgba(89, 58, 165, 0.6);
    } 

    #sendBtn {
  width: 150px;            /* 按钮更宽 */
  padding: 12px 24px;        /* 内边距更大，按钮更高 */
  font-size: 18px;           /* 字体更大 */
  font-weight: 600;          /* 字体加粗 */
  background-color: #7B5EEA; /* 更亮的紫色背景 */
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(123, 94, 234, 0.6);
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

#sendBtn:hover {
  background-color: #6846D9;
  box-shadow: 0 6px 18px rgba(104, 70, 217, 0.8);
}

#sendBtn:active {
  background-color: #5738B5;
  box-shadow: 0 2px 8px rgba(87, 56, 181, 0.9);
  transform: scale(0.98);
}


    @media (max-width: 768px) {
  html, body {
    height: 100%;
    margin: 0;
    overflow: hidden; /* 禁止页面上下滚动 */
    touch-action: manipulation; /* 允许基本触摸操作 */
  }

  #chatContainer {
    display: flex !important;
    flex-direction: column;
    height: 100vh; /* 占满视口高度 */
    max-height: 100vh;
  }

  .chat-header {
    flex: 0 0 48px; /* 固定高度 */
    line-height: 48px;
    padding-left: 60px; /* 保持左边按钮空间 */
  }

  .chat-messages {
    flex: 1 1 auto; /* 自适应占满剩余空间 */
    overflow-y: auto;
    -webkit-overflow-scrolling: touch; /* iOS顺滑滚动 */
    padding: 16px;
  }

  .chat-input {
    flex: 0 0 56px; /* 输入框固定高度 */
    padding: 8px 12px;
    box-sizing: border-box;
    background: #F7F8FC;
    border-top: 1px solid #E5E3F4;
  }

  .chat-input input {
    font-size: 16px;
    height: 40px;
  }
}


  </style>
</head>
<body>

  <!-- 房间输入 -->
  <div id="roomEntry">
    <div>
      <input id="roomInput" placeholder="输入房间号" />
      <button id="joinBtn">加入房间</button>
    </div>
  </div>

<!-- 聊天界面 -->
<div class="chat-container" id="chatContainer" style="display:none;">
  <div class="chat-header">
    <button id="callBtn" class="call-btn" title="语音通话" aria-label="语音通话">
      📞
    </button>
    房间中（支持语音+文字）
    <span id="statusIndicator">⚫ 离线</span>
  </div>

  <div class="chat-messages" id="messages"></div>
  
  <div class="chat-input">
    <input id="msgInput" placeholder="输入消息..." />
    <button id="sendBtn">发送</button>
  </div>
</div>


  <script>
  // 你的JS，保持不变
  let socket, pc, dataChannel, roomId, localStream;
  let isInitiator = false;
  let currentStatus = 'disconnected'; // disconnected | connected | calling

  document.getElementById('joinBtn').onclick = joinRoom;
  document.getElementById('sendBtn').onclick = sendMessage;
  document.getElementById('callBtn').onclick = startCall;

  function updateStatus(status) {
    currentStatus = status;
    const el = document.getElementById('statusIndicator');
    if (!el) return;

    if (status === 'connected') {
      el.textContent = '🟢 在线';
      el.style.color = 'green';
    } else if (status === 'calling') {
      el.textContent = '🔴 通话中';
      el.style.color = 'red';
    } else {
      el.textContent = '⚫ 离线';
      el.style.color = 'gray';
    }
  }

  function joinRoom() {
    roomId = document.getElementById('roomInput').value.trim();
    if (!roomId) return alert("请输入房间号");

    document.getElementById('roomEntry').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'flex';

    socket = new WebSocket('wss://c403e1bb-f98e-4527-b903-4d0f06a5d3bf-00-3sr8p3uo0fmuc.kirk.replit.dev/');

    socket.onopen = () => {
      console.log("✅ 已连接信令服务器");
      socket.send(JSON.stringify({ type: 'join', roomId }));
    };

    socket.onmessage = async (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === 'joined') {
        isInitiator = msg.initiator || false;
        createPeer();
      } 
      else if (msg.type === 'peer-joined') {
        // 对方加入，只有非 initiator 端需要创建 Peer（防止重复创建）
        if (!isInitiator && !pc) createPeer();
      }
      else if (msg.type === 'signal') {
        await handleSignal(msg.payload);
      }
      else if (msg.type === 'history') {
        // 显示历史消息
        if (Array.isArray(msg.messages)) {
          msg.messages.forEach(m => {
            appendMessage(`${m.from || '匿名'}: ${m.content}`, false);
          });
        }
      }
      else if (msg.type === 'message') {
        // 服务端广播的文字消息（其他人发来的）
        const p = msg.payload;
        if (p && p.content) appendMessage(`${p.from || '匿名'}: ${p.content}`, false);
      }
    };

    socket.onerror = (err) => console.error("WebSocket 错误：", err);
    socket.onclose = () => {
      console.warn("WebSocket 已关闭");
      updateStatus('disconnected');
    };
  }

  function createPeer() {
    pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    pc.onicecandidate = e => {
      if (e.candidate) {
        socket.send(JSON.stringify({
          type: 'signal',
          roomId,
          payload: { candidate: e.candidate }
        }));
      }
    };

    pc.ontrack = e => {
      const remoteAudio = new Audio();
      remoteAudio.srcObject = e.streams[0];
      remoteAudio.autoplay = true;
      console.log("✅ 收到远程音频流");
      updateStatus('calling');
    };

    pc.ondatachannel = e => {
      dataChannel = e.channel;
      setupDataChannel();
    };

    pc.onconnectionstatechange = () => {
      const state = pc.connectionState;
      console.log("连接状态变化：", state);

      if (state === 'connected') {
        updateStatus(localStream ? 'calling' : 'connected');
      } else if (state === 'disconnected' || state === 'failed' || state === 'closed') {
        updateStatus('disconnected');
      }
    };

    if (isInitiator) {
      dataChannel = pc.createDataChannel('chat');
      setupDataChannel();
    }
  }

  function setupDataChannel() {
  dataChannel.onopen = () => {
    console.log("✅ DataChannel 已连接");
    if (currentStatus !== 'calling') updateStatus('connected');
  };

  dataChannel.onclose = () => {
    console.log("❌ DataChannel 已关闭");
    updateStatus('disconnected');
  };

  dataChannel.onmessage = e => {
    appendMessage('对方: ' + e.data, false);
  };
}

function sendMessage() {
  const input = document.getElementById('msgInput');
  const txt = input.value.trim();
  if (!txt || !dataChannel || dataChannel.readyState !== 'open') return;

  // 先通过 DataChannel 发给对方
  dataChannel.send(txt);
  appendMessage('我: ' + txt, true);
  input.value = '';

  // 通过信令服务器存储消息（调用后端 messageStore 缓存）
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      type: 'message',
      roomId,
      payload: { from: '我', content: txt }
    }));
  }
}

function appendMessage(txt, isMe) {
  const box = document.getElementById('messages');
  const div = document.createElement('div');
  div.textContent = txt;
  div.style.textAlign = isMe ? 'right' : 'left';
  div.style.padding = '4px 8px';
  div.style.margin = '2px 0';
  div.style.borderRadius = '4px';
  div.style.backgroundColor = isMe ? '#daf1da' : '#f1f0f0';
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

async function handleSignal(data) {
  if (data.sdp) {
    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));

    if (data.sdp.type === 'offer') {
      await getLocalStream();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.send(JSON.stringify({
        type: 'signal',
        roomId,
        payload: { sdp: answer }
      }));
    }
  } else if (data.candidate) {
    try {
      await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
    } catch (err) {
      console.warn('添加 ICE 出错：', err);
    }
  }
}

async function startCall() {
  try {
    await getLocalStream();
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.send(JSON.stringify({
      type: 'signal',
      roomId,
      payload: { sdp: offer }
    }));
    console.log("🎤 发起语音通话");
    updateStatus('calling');
  } catch (err) {
    alert("语音通话失败：" + err.message);
  }
}

async function getLocalStream() {
  if (!localStream) {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: false,
          noiseSuppression: false,
          autoGainControl: false
        }
      });
      console.log("🎙️ 获取麦克风成功");
    } catch (err) {
      alert("无法访问麦克风: " + err.message);
      throw err;
    }
  }
}
</script> 

</body>
</html> 