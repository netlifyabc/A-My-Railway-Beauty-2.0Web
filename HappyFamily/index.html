<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®€æ˜“ WebRTC èŠå¤©</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #F7F8FC; /* æ¸…æ·¡é“¶æ²³ç° */
      color: #2B2346; /* æ·±æ˜Ÿç´« */
    }

    /* æˆ¿é—´è¾“å…¥ç•Œé¢ */
    #roomEntry {
      display: flex;
      height: 100vh;
      align-items: center;
      justify-content: center;
      background-color: #F7F8FC;
    }

    #roomEntry input {
      padding: 10px 14px;
      border: 1px solid #C3B7F0; /* æŸ”å’Œè“ç´«è¾¹æ¡† */
      border-radius: 10px;
      font-size: 16px;
      background-color: white;
      transition: border-color 0.2s;
    }

    #roomEntry input:focus {
      border-color: #8B6ECF; /* ä¸»è‰²è°ƒèšç„¦ */
      outline: none;
    }

    #roomEntry button {
      padding: 10px 16px;
      margin-left: 12px;
      background-color: #6A4FB6; /* å®‡å®™è“ç´« */
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(106, 79, 182, 0.4);
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    #roomEntry button:hover {
      background-color: #593aa5;
      box-shadow: 0 3px 8px rgba(89, 58, 165, 0.6);
    }

    /* èŠå¤©å®¹å™¨ */
    #chatContainer {
      display: none;
      flex-direction: column;
      height: 100vh;
      background-color: #F7F8FC;

      /* flexå®¹å™¨ */
      display: flex;
    }

    /* å¤´éƒ¨ */
    .chat-header {
      padding: 14px 16px;
      padding-left: 60px; /* ç»™å·¦è¾¹å¤šç•™å‡ºç‚¹ç©ºé—´ç»™æŒ‰é’® */
      background-color: #6A4FB6;
      color: white;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      position: relative;
      box-shadow: 0 2px 6px rgba(106, 79, 182, 0.4);
      user-select: none;

      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-shrink: 0; /* ä¸æ”¶ç¼© */
    }

    /* è¯­éŸ³æŒ‰é’®æ ·å¼ */
    .call-btn {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #8B6ECF;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 20px;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(139, 110, 207, 0.6);
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      z-index: 10;
    }

    .call-btn:hover {
      background-color: #6A4FB6;
      box-shadow: 0 4px 12px rgba(106, 79, 182, 0.8);
      transform: translateY(-50%) scale(1.1);
    }

    .call-btn:active {
      transform: translateY(-50%) scale(0.95);
    }

    #statusIndicator {
      position: absolute;
      right: 16px;
      top: 14px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.75);
    }

    /* èŠå¤©å†…å®¹åŒº */
    .chat-messages {
      flex: 1 1 auto; /* å…³é”®ï¼šæ’‘æ»¡å‰©ä½™ç©ºé—´ */
      padding: 32px 16px 16px 16px; /* é¡¶éƒ¨å¤šåŠ ç‚¹å†…è¾¹è· */
      overflow-y: auto;
      background-color: #ffffff;
      border-top: 1px solid #E5E3F4;
      border-bottom: 1px solid #E5E3F4;
      box-sizing: border-box; /* ç¡®ä¿paddingè®¡ç®—åœ¨å†… */
    }

    /* èŠå¤©æ°”æ³¡ */
    .chat-messages div {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 70%;
      word-break: break-word;
      font-size: 15px;
      background-color: #ECE8FF; /* æ·¡ç´«è‰²æ³¡æ³¡ */
      color: #2B2346;
      box-shadow: 0 1px 4px rgba(106, 79, 182, 0.15);
      transition: background-color 0.3s;
    }

    /* â€œæˆ‘â€çš„æ°”æ³¡æ ·å¼ */
    /* è¿™é‡Œä½ ç”¨JSæ§åˆ¶äº†èƒŒæ™¯è‰²ï¼ŒCSSé‡Œä¸ç”¨å†™ :has() äº† */

    /* è¾“å…¥åŒº */
    .chat-input {
      display: flex;
      padding: 14px 18px;
      background-color: #F7F8FC;
      border-top: 1px solid #E5E3F4;
      flex-shrink: 0; /* ä¸æ”¶ç¼© */
    }

    .chat-input input {
      flex: 1;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid #C3B7F0;
      border-radius: 10px;
      background-color: white;
      transition: border-color 0.3s;
    }

    .chat-input input:focus {
      border-color: #8B6ECF;
      outline: none;
    }

    .chat-input button {
      padding: 12px 18px;
      margin-left: 14px;
      font-size: 16px;
      background-color: #6A4FB6;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(106, 79, 182, 0.4);
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .chat-input button:hover {
      background-color: #593aa5;
      box-shadow: 0 3px 8px rgba(89, 58, 165, 0.6);
    } 

    #sendBtn {
  width: 150px;            /* æŒ‰é’®æ›´å®½ */
  padding: 12px 24px;        /* å†…è¾¹è·æ›´å¤§ï¼ŒæŒ‰é’®æ›´é«˜ */
  font-size: 18px;           /* å­—ä½“æ›´å¤§ */
  font-weight: 600;          /* å­—ä½“åŠ ç²— */
  background-color: #7B5EEA; /* æ›´äº®çš„ç´«è‰²èƒŒæ™¯ */
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(123, 94, 234, 0.6);
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

#sendBtn:hover {
  background-color: #6846D9;
  box-shadow: 0 6px 18px rgba(104, 70, 217, 0.8);
}

#sendBtn:active {
  background-color: #5738B5;
  box-shadow: 0 2px 8px rgba(87, 56, 181, 0.9);
  transform: scale(0.98);
}


    @media (max-width: 768px) {
  html, body {
    height: 100%;
    margin: 0;
    overflow: hidden; /* ç¦æ­¢é¡µé¢ä¸Šä¸‹æ»šåŠ¨ */
    touch-action: manipulation; /* å…è®¸åŸºæœ¬è§¦æ‘¸æ“ä½œ */
  }

  #chatContainer {
    display: flex !important;
    flex-direction: column;
    height: 100vh; /* å æ»¡è§†å£é«˜åº¦ */
    max-height: 100vh;
  }

  .chat-header {
    flex: 0 0 48px; /* å›ºå®šé«˜åº¦ */
    line-height: 48px;
    padding-left: 60px; /* ä¿æŒå·¦è¾¹æŒ‰é’®ç©ºé—´ */
  }

  .chat-messages {
    flex: 1 1 auto; /* è‡ªé€‚åº”å æ»¡å‰©ä½™ç©ºé—´ */
    overflow-y: auto;
    -webkit-overflow-scrolling: touch; /* iOSé¡ºæ»‘æ»šåŠ¨ */
    padding: 16px;
  }

  .chat-input {
    flex: 0 0 56px; /* è¾“å…¥æ¡†å›ºå®šé«˜åº¦ */
    padding: 8px 12px;
    box-sizing: border-box;
    background: #F7F8FC;
    border-top: 1px solid #E5E3F4;
  }

  .chat-input input {
    font-size: 16px;
    height: 40px;
  }
}


  </style>
</head>
<body>

  <!-- æˆ¿é—´è¾“å…¥ -->
  <div id="roomEntry">
    <div>
      <input id="roomInput" placeholder="è¾“å…¥æˆ¿é—´å·" />
      <button id="joinBtn">åŠ å…¥æˆ¿é—´</button>
    </div>
  </div>

<!-- èŠå¤©ç•Œé¢ -->
<div class="chat-container" id="chatContainer" style="display:none;">
  <div class="chat-header">
    <button id="callBtn" class="call-btn" title="è¯­éŸ³é€šè¯" aria-label="è¯­éŸ³é€šè¯">
      ğŸ“
    </button>
    æˆ¿é—´ä¸­ï¼ˆæ”¯æŒè¯­éŸ³+æ–‡å­—ï¼‰
    <span id="statusIndicator">âš« ç¦»çº¿</span>
  </div>

  <div class="chat-messages" id="messages"></div>
  
  <div class="chat-input">
    <input id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." />
    <button id="sendBtn">å‘é€</button>
  </div>
</div>


  <script>
  // ä½ çš„JSï¼Œä¿æŒä¸å˜
  let socket, pc, dataChannel, roomId, localStream;
  let isInitiator = false;
  let currentStatus = 'disconnected'; // disconnected | connected | calling

  document.getElementById('joinBtn').onclick = joinRoom;
  document.getElementById('sendBtn').onclick = sendMessage;
  document.getElementById('callBtn').onclick = startCall;

  function updateStatus(status) {
    currentStatus = status;
    const el = document.getElementById('statusIndicator');
    if (!el) return;

    if (status === 'connected') {
      el.textContent = 'ğŸŸ¢ åœ¨çº¿';
      el.style.color = 'green';
    } else if (status === 'calling') {
      el.textContent = 'ğŸ”´ é€šè¯ä¸­';
      el.style.color = 'red';
    } else {
      el.textContent = 'âš« ç¦»çº¿';
      el.style.color = 'gray';
    }
  }

  function joinRoom() {
    roomId = document.getElementById('roomInput').value.trim();
    if (!roomId) return alert("è¯·è¾“å…¥æˆ¿é—´å·");

    document.getElementById('roomEntry').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'flex';

    socket = new WebSocket('wss://c403e1bb-f98e-4527-b903-4d0f06a5d3bf-00-3sr8p3uo0fmuc.kirk.replit.dev/');

    socket.onopen = () => {
      console.log("âœ… å·²è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨");
      socket.send(JSON.stringify({ type: 'join', roomId }));
    };

    socket.onmessage = async (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === 'joined') {
        isInitiator = msg.initiator || false;
        createPeer();
      } 
      else if (msg.type === 'peer-joined') {
        // å¯¹æ–¹åŠ å…¥ï¼Œåªæœ‰é initiator ç«¯éœ€è¦åˆ›å»º Peerï¼ˆé˜²æ­¢é‡å¤åˆ›å»ºï¼‰
        if (!isInitiator && !pc) createPeer();
      }
      else if (msg.type === 'signal') {
        await handleSignal(msg.payload);
      }
      else if (msg.type === 'history') {
        // æ˜¾ç¤ºå†å²æ¶ˆæ¯
        if (Array.isArray(msg.messages)) {
          msg.messages.forEach(m => {
            appendMessage(`${m.from || 'åŒ¿å'}: ${m.content}`, false);
          });
        }
      }
      else if (msg.type === 'message') {
        // æœåŠ¡ç«¯å¹¿æ’­çš„æ–‡å­—æ¶ˆæ¯ï¼ˆå…¶ä»–äººå‘æ¥çš„ï¼‰
        const p = msg.payload;
        if (p && p.content) appendMessage(`${p.from || 'åŒ¿å'}: ${p.content}`, false);
      }
    };

    socket.onerror = (err) => console.error("WebSocket é”™è¯¯ï¼š", err);
    socket.onclose = () => {
      console.warn("WebSocket å·²å…³é—­");
      updateStatus('disconnected');
    };
  }

  function createPeer() {
    pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    pc.onicecandidate = e => {
      if (e.candidate) {
        socket.send(JSON.stringify({
          type: 'signal',
          roomId,
          payload: { candidate: e.candidate }
        }));
      }
    };

    pc.ontrack = e => {
      const remoteAudio = new Audio();
      remoteAudio.srcObject = e.streams[0];
      remoteAudio.autoplay = true;
      console.log("âœ… æ”¶åˆ°è¿œç¨‹éŸ³é¢‘æµ");
      updateStatus('calling');
    };

    pc.ondatachannel = e => {
      dataChannel = e.channel;
      setupDataChannel();
    };

    pc.onconnectionstatechange = () => {
      const state = pc.connectionState;
      console.log("è¿æ¥çŠ¶æ€å˜åŒ–ï¼š", state);

      if (state === 'connected') {
        updateStatus(localStream ? 'calling' : 'connected');
      } else if (state === 'disconnected' || state === 'failed' || state === 'closed') {
        updateStatus('disconnected');
      }
    };

    if (isInitiator) {
      dataChannel = pc.createDataChannel('chat');
      setupDataChannel();
    }
  }

  function setupDataChannel() {
  dataChannel.onopen = () => {
    console.log("âœ… DataChannel å·²è¿æ¥");
    if (currentStatus !== 'calling') updateStatus('connected');
  };

  dataChannel.onclose = () => {
    console.log("âŒ DataChannel å·²å…³é—­");
    updateStatus('disconnected');
  };

  dataChannel.onmessage = e => {
    appendMessage('å¯¹æ–¹: ' + e.data, false);
  };
}

function sendMessage() {
  const input = document.getElementById('msgInput');
  const txt = input.value.trim();
  if (!txt || !dataChannel || dataChannel.readyState !== 'open') return;

  // å…ˆé€šè¿‡ DataChannel å‘ç»™å¯¹æ–¹
  dataChannel.send(txt);
  appendMessage('æˆ‘: ' + txt, true);
  input.value = '';

  // é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å­˜å‚¨æ¶ˆæ¯ï¼ˆè°ƒç”¨åç«¯ messageStore ç¼“å­˜ï¼‰
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      type: 'message',
      roomId,
      payload: { from: 'æˆ‘', content: txt }
    }));
  }
}

function appendMessage(txt, isMe) {
  const box = document.getElementById('messages');
  const div = document.createElement('div');
  div.textContent = txt;
  div.style.textAlign = isMe ? 'right' : 'left';
  div.style.padding = '4px 8px';
  div.style.margin = '2px 0';
  div.style.borderRadius = '4px';
  div.style.backgroundColor = isMe ? '#daf1da' : '#f1f0f0';
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

async function handleSignal(data) {
  if (data.sdp) {
    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));

    if (data.sdp.type === 'offer') {
      await getLocalStream();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.send(JSON.stringify({
        type: 'signal',
        roomId,
        payload: { sdp: answer }
      }));
    }
  } else if (data.candidate) {
    try {
      await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
    } catch (err) {
      console.warn('æ·»åŠ  ICE å‡ºé”™ï¼š', err);
    }
  }
}

async function startCall() {
  try {
    await getLocalStream();
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.send(JSON.stringify({
      type: 'signal',
      roomId,
      payload: { sdp: offer }
    }));
    console.log("ğŸ¤ å‘èµ·è¯­éŸ³é€šè¯");
    updateStatus('calling');
  } catch (err) {
    alert("è¯­éŸ³é€šè¯å¤±è´¥ï¼š" + err.message);
  }
}

async function getLocalStream() {
  if (!localStream) {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: false,
          noiseSuppression: false,
          autoGainControl: false
        }
      });
      console.log("ğŸ™ï¸ è·å–éº¦å…‹é£æˆåŠŸ");
    } catch (err) {
      alert("æ— æ³•è®¿é—®éº¦å…‹é£: " + err.message);
      throw err;
    }
  }
}
</script> 

</body>
</html> 