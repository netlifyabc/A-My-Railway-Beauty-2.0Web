<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®€æ˜“ WebRTC èŠå¤©</title>
  <!-- CSSï¼ˆä½¿ç”¨ä½ åŸæœ‰çš„ï¼Œä¸é‡å¤ç²˜è´´ï¼‰ -->


  <style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: "Helvetica Neue", sans-serif;
    background: #ffffff;
    -webkit-overflow-scrolling: touch;
  }

  .chat-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #fff;
    z-index: 100;
  }

  .chat-header {
    height: 52px;
    background: #f8f8f8;
    color: #222;
    font-size: 17px;
    font-weight: 600;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-bottom: 1px solid #ddd;
    flex-shrink: 0;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px 14px 80px; /* ç•™å‡ºåº•éƒ¨è¾“å…¥æ¡†ç©ºé—´ */
    background: #f5f5f5;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .msg-row {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    max-width: 100%;
  }

  .msg-row.own {
    justify-content: flex-end;
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .msg-content {
    display: flex;
    flex-direction: column;
    max-width: 80%;
  }

  .nickname {
    font-size: 12px;
    color: #555;
    margin-bottom: 4px;
    user-select: none;
  }

  .msg-row.own .nickname {
    display: none;
  }

  .bubble {
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 15px;
    line-height: 1.5;
    word-break: break-word;
    box-shadow: 0 1px 1px rgba(0,0,0,0.05);
    transition: background 0.3s ease;
  }

  .msg-row.own .bubble {
    background: #95ec69;
    color: #000;
    border-bottom-right-radius: 4px;
  }

  .msg-row.other .bubble {
    background: #ffffff;
    color: #000;
    border-bottom-left-radius: 4px;
  }

  .chat-input {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: #fff;
    border-top: 1px solid #ddd;
    z-index: 200;
  }

  .chat-input input {
    flex: 1;
    padding: 10px 16px;
    font-size: 16px;
    border-radius: 24px;
    border: 1px solid #ccc;
    outline: none;
    background: #f7f7f7;
  }

  .chat-input button {
    margin-left: 10px;
    padding: 10px 16px;
    font-size: 16px;
    background: #007aff;
    border: none;
    border-radius: 20px;
    color: white;
    font-weight: 500;
    cursor: pointer;
  }

  .floating-call-btn {
    position: absolute;
    top: 12px;
    left: 12px;
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: rgba(250, 248, 245, 0.6);
    border: 1.5px solid rgba(210, 205, 198, 0.4);
    box-shadow:
      0 6px 12px rgba(210, 205, 198, 0.2),
      inset 0 1px 0 rgba(255 255 255 / 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 300;
    transition:
      transform 0.25s ease,
      box-shadow 0.25s ease,
      background 0.25s ease;
  }

  .floating-call-btn svg path {
    stroke: #b9b2a6;
    stroke-width: 2.2;
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  .floating-call-btn.active-call {
    background: rgba(198, 239, 217, 0.85);
    border-color: rgba(120, 200, 140, 0.7);
    box-shadow:
      0 0 8px 4px rgba(120, 200, 140, 0.4),
      inset 0 1px 0 rgba(255 255 255 / 0.95);
    color: #2f6f3e;
    animation: pulse 2.5s infinite ease-in-out;
  }

  .floating-call-btn.active-call svg path {
    stroke: #2f6f3e;
  }

  @keyframes pulse {
    0%, 100% {
      box-shadow:
        0 0 8px 4px rgba(120, 200, 140, 0.4),
        inset 0 1px 0 rgba(255 255 255 / 0.95);
    }
    50% {
      box-shadow:
        0 0 12px 8px rgba(120, 200, 140, 0.7),
        inset 0 1px 0 rgba(255 255 255 / 0.95);
    }
  }

  /* æˆ¿é—´å…¥å£æ ·å¼ä¸å˜ */
  .room-entry {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: linear-gradient(145deg, #f6f4f1, #e5e3e0);
    font-family: "Helvetica Neue", sans-serif;
  }

  .room-card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border-radius: 18px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    padding: 32px 24px;
    width: 100%;
    max-width: 320px;
    text-align: center;
    border: 1px solid rgba(210, 210, 210, 0.4);
    box-sizing: border-box;
  }

  .room-card input {
    width: 100%;
    box-sizing: border-box;
    padding: 12px 16px;
    font-size: 15px;
    border: 1px solid #ccc;
    border-radius: 24px;
    margin-bottom: 20px;
    outline: none;
    transition: border 0.3s ease;
    background-color: #fff;
  }

  .room-card input:focus {
    border-color: #007aff;
  }

  .room-card button {
    width: 100%;
    padding: 10px 0;
    background: #007aff;
    color: white;
    font-size: 15px;
    font-weight: 500;
    border: none;
    border-radius: 24px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .room-card button:hover {
    background: #0066d8;
  }

  #roomEntry {
    display: flex !important;
    align-items: center;
    justify-content: center;
    height: 100vh;
    width: 100vw;
    background: linear-gradient(145deg, #f6f4f1, #e5e3e0);
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
  }

  .actions {
    display: none; /* éšè—å¤šä½™æŒ‰é’®ï¼Œæé«˜æ²‰æµ¸æ„Ÿ */
  } 

@media screen and (max-width: 768px) {
  html {
    font-size: 18px !important; /* å¢å¼ºä¼˜å…ˆçº§ */
  }

  body {
    background: #fff !important;
  }

  .chat-container {
    margin: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    border-radius: 0 !important;
    box-shadow: none !important;
  }

  .chat-header {
    padding: 1rem !important;
    font-size: 1.1rem !important;
  }

  .chat-messages {
    padding: 1rem !important;
    font-size: 1rem !important;
    margin-bottom: 4.5rem !important; /* çº¦70px */
  }

  .msg-content .bubble {
    font-size: 1rem !important;
    padding: 0.7rem 1rem !important;
  }

  .msg-content .nickname {
    font-size: 0.75rem !important;
  }

  .avatar {
    width: 2.25rem !important; /* 36px */
    height: 2.25rem !important;
  }

  .chat-input {
    padding: 0.7rem !important;
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    background: #fafafa !important;
    z-index: 10 !important;
  }

  .chat-input input {
    padding: 0.8rem 1rem !important;
    font-size: 1rem !important;
    border-radius: 1.5rem !important;
  }

  .chat-input button {
    padding: 0.8rem 1.2rem !important;
    font-size: 1rem !important;
    border-radius: 1.5rem !important;
  }

  .floating-call-btn {
    top: 0.7rem !important;
    left: 0.7rem !important;
    width: 3rem !important;
    height: 3rem !important;
  }

  .actions {
    padding: 0.7rem !important;
    font-size: 1rem !important;
  }

  .actions button {
    padding: 0.6rem 1rem !important;
    font-size: 1rem !important;
  }

  .room-card {
    width: 92% !important;
    padding: 1.5rem 1rem !important;
    font-size: 1rem !important;
  }

  .room-card input,
  .room-card button {
    font-size: 1rem !important;
    padding: 0.8rem 1rem !important;
  }
}

</style> 


</head>
<body>
  <!-- æˆ¿é—´å…¥å£ç•Œé¢ -->
  <div id="roomEntry" class="room-entry">
    <div class="room-card">
      <input id="roomInput" placeholder="è¾“å…¥æˆ¿é—´å·" />
      <button id="joinBtn">åŠ å…¥æˆ¿é—´</button>
    </div>
  </div>

  <!-- èŠå¤©ç•Œé¢ -->
  <div class="chat-container" id="chatContainer" style="display: none;">
    <div class="chat-header">ç¾¤èŠï¼ˆè¯­éŸ³æ”¯æŒï¼‰</div>
    <button class="floating-call-btn" id="callBtn">ğŸ“</button>
    <div class="chat-messages" id="messages"></div>
    <div class="chat-input">
      <input type="text" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." />
      <button id="sendBtn">å‘é€</button>
    </div>
  </div>

<script>
let socket, pc, dataChannel, localStream, roomId;

document.getElementById('joinBtn').addEventListener('click', joinRoom);
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('callBtn').addEventListener('click', startCall);

function joinRoom() {
  roomId = document.getElementById('roomInput').value.trim();
  if (!roomId) return alert('è¯·è¾“å…¥æˆ¿é—´å·');

  document.getElementById('roomEntry').style.display = 'none';
  document.getElementById('chatContainer').style.display = 'flex';

  socket = new WebSocket('https://c403e1bb-f98e-4527-b903-4d0f06a5d3bf-00-3sr8p3uo0fmuc.kirk.replit.dev/'); // æ›¿æ¢ä¸ºä½ çš„åœ°å€

  socket.addEventListener('open', () => {
    socket.send(JSON.stringify({ type: 'join', roomId }));
  });

  socket.addEventListener('message', async (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'joined') {
      const isInitiator = await checkIfInitiator();
      createPeer(isInitiator);
    } else if (msg.type === 'peer-joined') {
      // è¢«åŠ¨æ–¹ä¹Ÿéœ€åˆ›å»ºè¿æ¥
      const isInitiator = false;
      createPeer(isInitiator);
    } else if (msg.type === 'signal') {
      await handleSignal(msg.payload);
    }
  });

  socket.addEventListener('close', () => alert('é€šä¿¡å·²æ–­å¼€'));
  socket.addEventListener('error', err => console.error('WebSocket é”™è¯¯ï¼š', err));
}

// è¾…åŠ©ï¼šå†³å®šæ˜¯å¦æ˜¯æˆ¿ä¸»ï¼ˆç¬¬ä¸€ä¸ªè¿›å…¥çš„ï¼‰
async function checkIfInitiator() {
  return new Promise(resolve => {
    setTimeout(() => {
      // ç²—ç•¥åˆ¤æ–­ï¼š2s å†…å¦‚æœæ²¡æœ‰ peer-joined è¯´æ˜æ˜¯ initiator
      resolve(true);
    }, 2000);
    socket.addEventListener('message', msg => {
      const data = JSON.parse(msg.data);
      if (data.type === 'peer-joined') resolve(false);
    }, { once: true });
  });
}

function createPeer(isCaller) {
  console.log('åˆ›å»ºè¿æ¥ï¼ŒisCaller:', isCaller);
  pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

  pc.addEventListener('icecandidate', e => {
    if (e.candidate) {
      socket.send(JSON.stringify({ type: 'signal', roomId, payload: { candidate: e.candidate } }));
    }
  });

  pc.addEventListener('track', e => {
    const remoteAudio = new Audio();
    remoteAudio.srcObject = e.streams[0];
    remoteAudio.autoplay = true;
    console.log('æ”¶åˆ°è¿œç«¯éŸ³é¢‘');
  });

  pc.addEventListener('iceconnectionstatechange', () => {
    console.log('ICE çŠ¶æ€ï¼š', pc.iceConnectionState);
  });

  if (isCaller) {
    dataChannel = pc.createDataChannel('chat');
    setupChannel();
  } else {
    pc.addEventListener('datachannel', e => {
      dataChannel = e.channel;
      setupChannel();
    });
  }
}

function setupChannel() {
  dataChannel.onmessage = e => appendMessage(e.data, false);
}

function sendMessage() {
  const input = document.getElementById('msgInput');
  const txt = input.value.trim();
  if (!txt || !dataChannel || dataChannel.readyState !== 'open') return;
  dataChannel.send(txt);
  appendMessage(txt, true);
  input.value = '';
}

function appendMessage(txt, own) {
  const cont = document.getElementById('messages');
  const row = document.createElement('div');
  row.className = 'msg-row ' + (own ? 'own' : 'other');
  const avatar = document.createElement('img');
  avatar.className = 'avatar';
  avatar.src = own
    ? 'https://api.dicebear.com/7.x/thumbs/svg?seed=Me'
    : 'https://api.dicebear.com/7.x/thumbs/svg?seed=Them';

  const content = document.createElement('div');
  content.className = 'msg-content';
  if (!own) {
    const name = document.createElement('div');
    name.className = 'nickname';
    name.textContent = 'å¯¹æ–¹';
    content.appendChild(name);
  }
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = txt;
  content.appendChild(bubble);

  if (own) {
    row.appendChild(content);
    row.appendChild(avatar);
  } else {
    row.appendChild(avatar);
    row.appendChild(content);
  }
  cont.appendChild(row);
  cont.scrollTop = cont.scrollHeight;
}

async function handleSignal(data) {
  if (data.sdp) {
    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    if (data.sdp.type === 'offer') {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.send(JSON.stringify({ type: 'signal', roomId, payload: { sdp: answer } }));
    }
  } else if (data.candidate) {
    try {
      await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
    } catch (err) {
      console.warn('æ·»åŠ  ICE å¤±è´¥ï¼š', err);
    }
  }
}

async function startCall() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.send(JSON.stringify({ type: 'signal', roomId, payload: { sdp: offer } }));
    document.getElementById('callBtn').classList.add('active-call');
  } catch (err) {
    console.error('éº¦å…‹é£è·å–å¤±è´¥:', err);
    alert('æ— æ³•è®¿é—®éº¦å…‹é£');
  }
}
</script>
</body>
</html> 